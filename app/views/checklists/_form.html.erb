<%= labelled_fields_for :checklist, checklist do |f| %>
  <%= call_hook(:view_checklists_form_details_top, { :checklist => checklist, :form => f }) %>
  <%= hidden_field_tag 'form_update_triggered_by', '' %>
  <%= hidden_field_tag 'back_url', params[:back_url], :id => nil if params[:back_url].present? %>
  <% if issue %>
    <%= hidden_field_tag 'issue_id', issue.id, :id => nil %>
  <% end %>

  <% if checklist.safe_attribute? 'is_private' %>
    <p id="checklist_is_private_wrap">
      <%= f.check_box :is_private, :no_label => true %><label class="inline" for="checklist_is_private" id="checklist_is_private_label"><%= l(:field_is_private) %></label>
    </p>
  <% end %>

  <% projects = checklist.allowed_target_projects(User.current, project) %>
  <% if (checklist.safe_attribute?('project_id') || checklist.project_id_changed?) && (project.nil? || projects.length > 1) %>
    <p><%= f.select :project_id, project_tree_options_for_select(projects, :selected => checklist.project), {:required => true} %></p>
  <% end %>

  <% if checklist.safe_attribute?('tracker_id') || (checklist.persisted? && checklist.tracker_id_changed?) %>
    <p>
      <%= f.select :tracker_id, trackers_options_for_select(issue), {:required => true} %>
      <%= content_tag 'a', l(:label_open_trackers_description), :class => 'icon-only icon-help', :title => l(:label_open_trackers_description), :onclick => "showModal('trackers_description', '500px'); return false;", :href => '#' if trackers_for_select(issue).any? {|t| t.description.present? } %>
    </p>
  <% end %>

  <% if checklist.safe_attribute? 'subject' %>
    <p><%= f.text_field :subject, :size => 80, :maxlength => 255, :required => true %></p>
  <% end %>

  <% if checklist.safe_attribute? 'description' %>
    <p>
      <%= f.label_for_field :description, :required => checklist.required_attribute?('description') %>
      <%= link_to_function content_tag(:span, l(:button_edit), :class => 'icon icon-edit'), '$(this).hide(); $("#checklist_description_and_toolbar").show()' unless checklist.new_record? %>
      <%= content_tag 'span', :id => "checklist_description_and_toolbar", :style => (checklist.new_record? ? nil : 'display:none') do %>
        <%= f.text_area :description, :cols => 60, :accesskey => accesskey(:edit),
          :class => 'wiki-edit',
          :rows => [[10, checklist.description.to_s.length / 50].max, 20].min,
          :data => {
            :auto_complete => true,
            :issues_url => auto_complete_issues_path(:project_id => issue.project, :q => '')
          },
          :no_label => true %>
      <% end %>
    </p>
    <%= wikitoolbar_for 'checklist_description', checklist_preview_path() %>
  <% end %>

  <div id="attributes" class="attributes">
    <%= render :partial => 'checklists/attributes', :locals => {
      :checklist => checklist,
      :allowed_statuses => allowed_statuses,
      :priorities => priorities,
      :project => project
    } %>
  </div>

  <%= call_hook(:view_checklists_form_details_bottom, { :checklist => checklist, :form => f }) %>
<% end %>

<% heads_for_wiki_formatter %>
