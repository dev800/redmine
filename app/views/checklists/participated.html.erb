<%
  request_url ||= request.url

  # locals: { checklists, issue }

  ######################### participated #################################
  participated_type_params = {}

  if params[:checklists_status]
    participated_type_params.merge!(checklists_status: params[:checklists_status])
  end

  if params[:checklists_tracker]
    participated_type_params.merge!(checklists_tracker: params[:checklists_tracker])
  end

  checklists_participants_type_options = Participant::ROLES.map do |role|
    [
      l(:"label_participant_type_#{role}"),
      "type:is_#{role}",
      {
        href: generate_replace_href(request_url, checklists_participants_type: "type:is_#{role}"),
        "data-href": participated_checklists_url(participated_type_params.merge(checklists_participants_type: "type:is_#{role}"))
      }
    ]
  end

  default_participated_type_options = [
    [
      l(:label_all),
      'type:all',
      {
        href: generate_replace_href(request_url, checklists_participants_type: 'type:all'),
        "data-href": participated_checklists_url(participated_type_params.merge(checklists_participants_type: "type:all"))
      }
    ]
  ]

  checklists_participants_type_options = if checklists_participants_type_options.any?
    default_participated_type_options + [['- - - -', { disabled: true }]] + checklists_participants_type_options
  else
    default_participated_type_options
  end

  ######################### tracker #################################
  tracker_params = {}

  if params[:checklists_status]
    tracker_params.merge!(checklists_status: params[:checklists_status])
  end

  if params[:checklists_participants_type]
    tracker_params.merge!(checklists_participants_type: params[:checklists_participants_type])
  end

  checklist_tracker_options = Checklist.participants_of_user(@user, {
    tracker: "tracker:all",
    status: params[:checklists_status],
    participants_type: params[:checklists_participants_type]
  }).map(&:tracker).sort do |t1, t2|
    t1.position <=> t2.position
  end.map do |tracker|
    [
      tracker.name,
      "id:#{tracker.id}",
      {
        href: generate_replace_href(request_url, checklists_tracker: "id:#{tracker.id}"),
        "data-href": participated_checklists_url(tracker_params.merge(checklists_tracker: "id:#{tracker.id}"))
      }
    ]
  end.uniq

  default_checklist_tracker_options = [
    [
      l(:label_all),
      'tracker:all',
      {
        href: generate_replace_href(request_url, checklists_tracker: 'tracker:all'),
        "data-href": participated_checklists_url(tracker_params.merge(checklists_tracker: "tracker:all"))
      }
    ]
  ]

  checklist_tracker_options = if checklist_tracker_options.any?
    default_checklist_tracker_options + [['- - - -', { disabled: true }]] + checklist_tracker_options
  else
    default_checklist_tracker_options
  end

  ######################### status #################################
  status_params = {}

  if params[:checklists_tracker]
    status_params.merge!(checklists_tracker: params[:checklists_tracker])
  end

  if params[:checklists_participants_type]
    status_params.merge!(checklists_participants_type: params[:checklists_participants_type])
  end

  checklist_status_options = Checklist.participants_of_user(@user, {
    tracker: params[:checklists_tracker],
    status: "status:all",
    participants_type: params[:checklists_participants_type]
  }).map(&:status).sort do |s1, s2|
    s1.position <=> s2.position
  end.map do |status|
    [
      status.name,
      "id:#{status.id}",
      {
        href: generate_replace_href(request_url, checklists_status: "id:#{status.id}"),
        "data-href": participated_checklists_url(status_params.merge(checklists_status: "id:#{status.id}"))
      }
    ]
  end.uniq

  default_checklist_status_options = [
    [
      l(:label_all),
      'status:all',
      {
        href: generate_replace_href(request_url, checklists_status: 'status:all'),
        "data-href": participated_checklists_url(status_params.merge(checklists_status: "status:all"))
      }
    ],
    [
      l(:label_open_issues),
      'status:open',
      {
        href: generate_replace_href(request_url, checklists_status: 'status:open'),
        "data-href": participated_checklists_url(status_params.merge(checklists_status: "status:open"))
      }
    ],
    [
      l(:label_closed_issues),
      'status:closed',
      {
        href: generate_replace_href(request_url, checklists_status: 'status:closed'),
        "data-href": participated_checklists_url(status_params.merge(checklists_status: "status:closed"))
      }
    ]
  ]

  checklist_status_options = if checklist_status_options.any?
    default_checklist_status_options + [['- - - -', { disabled: true }]] + checklist_status_options
  else
    default_checklist_status_options
  end

  participants = Participant.where(
    :partable_type => Checklist.to_s,
    :partable_id => @checklists.map(&:id),
    :user_id => User.current.id
  ).all

  participants_index = participants.index_by(&:partable_id)
%>

<div id="participated-checklists">
  <div class="list-filter">
    <label class="list-filter-label"><%= l(:label_as) %>：</label><%= select_tag :checklists_participants_type, options_for_select(checklists_participants_type_options, params[:checklists_participants_type] || "type:all"), :class => "filter-trigger" %>
    <%= select_tag :checklists_tracker, options_for_select(checklist_tracker_options, params[:checklists_tracker] || Issue::DEFAULT_CHECKLISTS_TRACKER), :class => "filter-trigger" %>
    <%= select_tag :checklists_status, options_for_select(checklist_status_options, params[:checklists_status] || Issue::DEFAULT_CHECKLISTS_STATUS), :class => "filter-trigger" %>
  </div>
  <h3 class="list-title"><%= l(:label_participanted_checklists) %></h3>
  <% if @checklists.any? %>
    <table class="list checklists-list">
      <tr>
        <th><%= l(:field_project) %></th>
        <th><%= l(:field_status) %></th>
        <th><%= l(:field_title) %></th>
      </tr>
      <% @checklists.each do |checklist| %>
        <% participant = participants_index[checklist.id] %>
        <tr class="<%= checklist.css_classes %>">
          <td class="project"><%= link_to_project(checklist.project) %></td>
          <td class="status"><%= checklist.status.name %></td>
          <td class="subject">
            <%= link_to_checklist(checklist) %>
            <% if participant.try(:roles_description_short).present? %>
              <span class="roles-description with-help" title="<%= participant.try(:roles_description) %>">
                【<%= participant.try(:roles_description_short) %>】
              </span>
            <% end %>
          </td>
        </tr>
      <% end %>
    </table>
  <% else %>
    <div class="list-empty"><%= l(:label_checklists_empty) %></div>
  <% end %>
</div>
